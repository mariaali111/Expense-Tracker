{% extends "base.html" %}

{% block title %}Dashboard · Expense Tracker{% endblock %}

{% block content %}
<main class="mx-auto max-w-6xl px-4 py-8">
  <h1 class="text-3xl font-semibold mb-2">Dashboard</h1>
  <p class="text-slate-500 dark:text-slate-400 mb-6">
    Track spending, filter by date/category, and visualize instantly.
  </p>

  <!-- Filters + Add form -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Filters -->
    <section class="lg:col-span-2 rounded-2xl border border-pink-100 dark:border-slate-800 bg-white dark:bg-slate-900 p-4">
      <h2 class="text-lg font-semibold mb-3">Filters</h2>
      <form method="get" action="{{ url_for('index') }}" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end pr-5">
        <label class="text-sm">
          <span class="block mb-1 text-slate-600 dark:text-slate-300">Start</span>
          <input name="start" value="{{ start_str or '' }}" type="date"
            class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100" />
        </label>
        <label class="text-sm">
          <span class="block mb-1 text-slate-600 dark:text-slate-300">End</span>
          <input name="end" value="{{ end_str or '' }}" type="date"
            class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100" />
        </label>
        <label class="text-sm md:col-span-2">
          <span class="block mb-1 text-slate-600 dark:text-slate-300">Category</span>
          <select name="category"
            class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100">
            <option value="">All</option>
            {% for c in categories %}
            <option value="{{ c }}"" {% if selected_category == c %} selected {% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="flex gap-2">
          <button class="rounded-xl bg-brand/20 hover:bg-brand/30 text-brand px-4 py-2 border border-brand/30"
            type="submit">
            Apply
          </button>
          <a class="rounded-xl  bg-pink-50 hover:bg-pink-100 dark:bg-slate-800 dark:hover:bg-slate-700 px-4 py-2 border border-pink-100 dark:border-slate-700"
            href="{{ url_for('index') }}">Reset</a>
        </div>
      </form>

      <!-- Total -->
      <div class="mt-4 text-sm text-slate-600 dark:text-slate-300">
        <span class="mr-2">Total:</span>
        <span class="inline-block rounded-xl border border-pink-100 dark:border-slate-700 bg-pink-50 dark:bg-slate-800 px-3 py-1 font-semibold">
          ${{ "%.2f"|format(total or 0) }}
        </span>
      </div>

      <!-- Export link -->
      <div class="mt-3">
        <a class="text-xs text-slate-500 dark:text-slate-400 hover:text-brand underline" 
          href="{{ url_for('export_csv', start=start_str, end=end_str, category=selected_category) }}"
        >
          Export CSV (current filter)
        </a>
      </div>
    </section>

    <!-- Add Expense -->
    <section class="rounded-2xl border border-pink-100 dark:border-slate-800 bg-white dark:bg-slate-900 p-4">
      <h2 class="text-lg font-semibold mb-3">Add Expense</h2>
      <form method="post" action="{{url_for('add')}}" class="space-y-3">
        <label class="block text-sm">
          <span class="mb-1 block text-slate-600 dark:text-slate-300">Description</span>
          <input name="description" placeholder="e.g., Groceries"
            class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100" />
        </label>
        <div class="grid grid-cols-2 gap-3">
          <label class="block text-sm">
            <span class="mb-1 block text-slate-600 dark:text-slate-300">Amount</span>
            <input name="amount" type="number" step="0.01" min="0.01" placeholder="25.00"
              class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100" />
          </label>
          <label class="block text-sm">
            <span class="mb-1 block text-slate-600 dark:text-slate-300">Date</span>
            <input name="date" value="{{ today }}" type="date"
              class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100" />
          </label>
        </div>
        <label class="block text-sm">
          <span class="mb-1 block text-slate-600 dark:text-slate-300">Category</span>
          <select name="category"
            class="w-full rounded-xl bg-pink-50 dark:bg-slate-800 border border-pink-100 dark:border-slate-700 px-3 py-2 text-slate-900 dark:text-slate-100">
            {% for c in categories %}

            <option value="{{ c }}">{{ c }}</option>

            {% endfor %}
          </select>
        </label>
        <button class="w-full rounded-xl bg-brand/20 hover:bg-brand/30 text-brand px-4 py-2 border border-brand/30"
          type="submit">
          Add Expense
        </button>
      </form>
    </section>
  </div>

  <!-- Total (global) -->
  <div class="mb-3 mt-6">
    <span class="text-sm text-slate-600 dark:text-slate-300 mr-2">Total:</span>
    <span class="inline-block rounded-xl border border-pink-200 dark:border-slate-700 bg-pink-100 dark:bg-slate-800 px-3 py-1 font-semibold">
      ${{ "%.2f"|format(total or 0) }}
    </span>
  </div>

  <!-- Expenses table -->
  <section class="rounded-2xl border border-pink-100 dark:border-slate-800 bg-white dark:bg-slate-900">
    <div class="px-4 py-3 border-b border-pink-100 dark:border-slate-800">
      <h2 class="text-lg font-semibold">Expenses</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-slate-600 dark:text-slate-300 bg-pink-100/70 dark:bg-slate-800/50">
          <tr>
            <th class="text-left px-4 py-3">Date</th>
            <th class="text-left px-4 py-3">Description</th>
            <th class="text-left px-4 py-3">Category</th>
            <th class="text-right px-4 py-3">Amount</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody>

          {% if expenses %}

          {% for e in expenses %}

          <tr class="border-t border-pink-200 dark:border-slate-800 hover:bg-pink-100/70 dark:hover:bg-slate-800/30">
            <td class="px-4 py-2">{{ e.date.strftime("%m-%d-%Y") if e.date else "" }}</td>
            <td class="px-4 py-2">{{ e.description }}</td>
            <td class="px-4 py-2">{{ e.category }}</td>
            <td class="px-4 py-2 text-right">${{ "%.2f"|format(e.amount) }}</td>
            <td class="px-4 py-2 text-right">

              <div class="inline-flex gap-2">
                <a class="
                text-sky-400
                dark:text-sky-300
                hover:text-sky-400
                dark:hover:text-sky-200
                text-xs 
                border 
                border-sky-600/30
                dark:border-sky-400/30
                px-3
                py-1
                rounded-lg
                "
                href="{{ url_for('edit', expense_id=e.id) }}">EDIT</a>

              <form 
                method="post" 
                action="{{ url_for('delete', expense_id=e.id) }}"
                onsubmit="return confirm('Are you sure you want to delete?')"
              >
                <button
                  class="text-rose-300 hover:text-rose-200 text-xs border border-rose-400/30 px-3 py-1 rounded-lg">
                  Delete
                </button>
              </form>

              </div>

            </td>
          </tr>

          {% endfor %}

          {% else %}

          <tr>
            <td colspan="5" class="px-4 py-6 text-center text-slate-500 dark:text-slate-400">
              No expenses yet — add your first one above.
            </td>
          </tr>

          {% endif %}

        </tbody>
      </table>
    </div>
  </section>

  <!-- Charts -->
  <section class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="rounded-2xl border border-pink-200 dark:border-slate-800 bg-pink-100 dark:bg-slate-900 p-4">
      <h3 class="font-semibold mb-2">By Category</h3>
      <canvas id="catChart" height="140"></canvas>
    </div>
    <div class="rounded-2xl border border-pink-200 dark:border-slate-800 bg-pink-100 dark:bg-slate-900 p-4">
      <h3 class="font-semibold mb-2">Spending Over Time</h3>
      <canvas id="dayChart" height="140"></canvas>
    </div>
  </section>

  <script>
    const isDark = document.documentElement.classList.contains('dark');
    const chartTextColor = isDark ? '#cbd5e1' : '#475569';

    const catLabels = {{ (cat_labels or[]) | tojson }};
    const catValues = {{ (cat_values or[]) | tojson }};
    const dayLabels = {{ (day_labels or[]) | tojson }};
    const dayValues = {{ (day_values or[]) | tojson }};

    if (document.getElementById('catChart')) {
      const catCtx = document.getElementById('catChart').getContext('2d')

      new Chart(catCtx, {
        type: 'pie',
        data: { labels: catLabels, datasets: [{ data: catValues }] },
        options: { plugins: { legend: { labels: { color: chartTextColor } } } }
      });
    }

    if (document.getElementById('dayChart')) {
      const dayCtx = document.getElementById('dayChart').getContext('2d')

      new Chart(dayCtx, {
        type: 'bar',
        data: {
          labels: dayLabels, datasets: [{
            label: 'Total',
            data: dayValues
          }]
        },
        options: {
          plugins: {
            legend: {
              labels: {
                color: chartTextColor
              }
            }
          },
          scales: {
            x: {ticks: {color: chartTextColor}, grid: {color: '#334155'}},
            y: {ticks: {color: chartTextColor}, grid: {color: '#334155'}}
          }
        }
      });
    }


  </script>

  {% endblock %}